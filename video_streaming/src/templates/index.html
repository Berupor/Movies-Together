<!DOCTYPE html>
<html lang="eng">
<head>
    <title>Video Streaming App</title>
    <link href="https://vjs.zencdn.net/8.0.4/video-js.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/css/styles.css">

</head>
<body>
<div id="video-container">
    <video
            id="my-video"
            class="video-js"
            controls
            muted
            preload="auto"
            width="640"
            height="400"
            poster="https://www.dpreview.com/files/p/articles/5544316196/CleanShot_2022-03-15_at_20.28.02.jpeg"
            data-setup="{}">

        <source src="/video" type="video/mp4"/>
        <p class="vjs-no-js">
            To view this video please enable JavaScript, and consider upgrading to a
            web browser that
            <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
        </p>
    </video>

    <script src="https://vjs.zencdn.net/8.0.4/video.min.js"></script>
</div>

<script>
    const player = videojs('my-video');
    const socket = new WebSocket("ws://localhost:8000/ws");
    const randomUserName = Math.random().toString(36).substring(7);
    let lastTime = player.currentTime();
    let paused = true;
    socket.onmessage = function (event) {
        const eventData = JSON.parse(event.data);
        const eventName = eventData.event_name;
        const user = eventData.user;

        if (user !== randomUserName) {
            if (eventName === "play" && paused) {
                player.play();
                paused = false;
                console.log('play');

            } else if (eventName === "pause" && !paused) {
                player.pause();
                paused = true;
                console.log('pause');

            } else if (eventName === "change_time") {
                let currentTimeInt = parseInt(player.currentTime());
                let eventTimeInt = parseInt(eventData.time);
                if (currentTimeInt !== eventTimeInt) {
                    player.currentTime(eventData.time);
                }
            }
        }
    };

    player.on('pause', function () {
        const data = {
            event_name: 'pause',
            user: randomUserName
        };
        if (!paused) {
            socket.send(JSON.stringify(data));
            paused = true;
        }

    });

    player.on('play', function () {
        const data = {
            event_name: 'play',
            user: randomUserName
        };
        if (paused) {
            socket.send(JSON.stringify(data));
            paused = false;

        }
    });

    player.on('seeked', function () {
        const currentTime = player.currentTime();

        if (currentTime !== lastTime) {
            lastTime = currentTime;
            const data = {
                time: currentTime,
                event_name: 'change_time',
                user: randomUserName
            };
            socket.send(JSON.stringify(data))
        }
    });

</script>

</body>
</html>
